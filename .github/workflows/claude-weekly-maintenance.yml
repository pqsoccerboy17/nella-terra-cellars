name: Claude Weekly Maintenance

on:
  schedule:
    - cron: "0 14 * * 1"
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run maintenance check with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: |
            Perform a weekly maintenance check on this repository and create a GitHub issue summarizing your findings.

            Check the following:
            1. Outdated dependencies - Run `npm outdated` and note any packages behind by a major version
            2. Security vulnerabilities - Run `npm audit` and summarize any high or critical issues
            3. TODO/FIXME/HACK comments - Search the codebase for these markers and list them with file locations
            4. General health - Note any obvious issues like unused imports, dead code, or missing error handling

            Create a GitHub issue titled "Weekly Maintenance Report - [today's date]" with your findings organized by category.
            If everything looks healthy, still create the issue but note that no action items were found.
          claude_args: >-
            --max-turns 15
            --allowedTools "Read,Glob,Grep,LS,Bash(npm audit:*),Bash(npm outdated:*),Bash(grep:*)"
